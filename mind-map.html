<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ€ç»´æ˜Ÿå›¾ Â· æˆ‘çš„æ€ç»´å®‡å®™</title>

<!-- D3.js ç”¨æ¥ç”»æ˜Ÿå›¾ -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top, #bbf7d0, #dcfce7, #fefce8);
        min-height: 100vh;
    }

    header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:14px 18px;
        background:#14532d;
        color:white;
        box-shadow:0 2px 8px rgba(0,0,0,0.25);
    }

    header .left {
        display:flex;
        align-items:center;
        gap:10px;
    }

    header img {
        height:38px;
        border-radius:10px;
    }

    header .title-main {
        font-size:18px;
        font-weight:bold;
    }
    header .title-sub {
        font-size:12px;
        opacity:0.8;
    }

    header button {
        background:#22c55e;
        border:none;
        color:white;
        padding:8px 12px;
        border-radius:999px;
        font-size:13px;
        cursor:pointer;
    }

    .container {
        max-width:900px;
        margin:0 auto;
        padding:20px;
    }

    .card {
        background:rgba(255,255,255,0.8);
        backdrop-filter:blur(12px);
        border-radius:20px;
        padding:20px;
        box-shadow:0 12px 40px rgba(0,0,0,0.12);
        margin-top:18px;
        position:relative;
    }

    .card::after {
        content:"ğŸ¸";
        position:absolute;
        top:14px;
        right:18px;
        font-size:20px;
        opacity:0.8;
    }

    .section-title {
        font-size:18px;
        font-weight:bold;
        color:#14532d;
        margin-bottom:8px;
    }

    .section-desc {
        font-size:14px;
        color:#4b5563;
        line-height:1.7;
        margin-bottom:10px;
    }

    #map-container {
        margin-top:10px;
        border-radius:18px;
        background:radial-gradient(circle at top,#bbf7d0,#ecfdf5,#fefce8);
        border:1px solid rgba(148,163,184,0.3);
        overflow:hidden;
    }

    svg {
        width:100%;
        height:480px;
        display:block;
    }

    .node circle {
        cursor:pointer;
        stroke:white;
        stroke-width:1.5px;
    }

    .node text {
        font-size:12px;
        pointer-events:none;
        fill:#064e3b;
        text-shadow:0 1px 2px rgba(255,255,255,0.7);
    }

    .tooltip {
        position:absolute;
        padding:6px 10px;
        background:rgba(15,23,42,0.9);
        color:white;
        font-size:12px;
        border-radius:8px;
        pointer-events:none;
        white-space:nowrap;
    }

    .range-pill {
        display:inline-block;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid #22c55e;
        font-size:12px;
        cursor:pointer;
        margin-right:6px;
        color:#166534;
        background:#ecfdf5;
    }
    .range-pill.active {
        background:#22c55e;
        color:white;
    }

    .nodata {
        padding:16px;
        font-size:14px;
        color:#64748b;
    }
</style>
</head>
<body>

<header>
  <div class="left">
    <img src="ChatGPT Image 2025å¹´11æœˆ17æ—¥ 17_47_21.png" alt="frog">
    <div>
      <div class="title-main">æ€ç»´æ˜Ÿå›¾ Â· æˆ‘çš„æ€ç»´å®‡å®™</div>
      <div class="title-sub">åŸºäºä½ æ‰€æœ‰å†å²è®°å½•ç”Ÿæˆçš„å…³é”®è¯æ˜Ÿå›¾</div>
    </div>
  </div>

  <button onclick="window.location.href='index.html'">â† è¿”å›è®­ç»ƒä¸»é¡µ</button>
</header>

<div class="container">

  <div class="card">
    <div class="section-title">è¯´æ˜</div>
    <div class="section-desc">
      è¿™é‡Œå±•ç¤ºçš„æ˜¯ä½ åœ¨ã€Œæ€ç»´å†’é™©è€…ã€é‡Œå†™ä¸‹çš„æ‰€æœ‰å†…å®¹ä¸­ï¼Œè‡ªåŠ¨æå–å‡ºçš„é«˜é¢‘å…³é”®è¯ã€‚<br>
      Â· ç»¿è‰²åœ†ç‚¹ä»£è¡¨ä¸€ä¸ªå…³é”®è¯ï¼Œè¶Šå¤§å‡ºç°å¾—è¶Šé¢‘ç¹ã€‚<br>
      Â· åœ†ç‚¹ä¹‹é—´çš„è¿çº¿ä»£è¡¨å®ƒä»¬åœ¨åŒä¸€æ¡è®°å½•ä¸­ç»å¸¸ä¸€èµ·å‡ºç°ã€‚<br>
      Â· æŠŠé¼ æ ‡ç§»åŠ¨åˆ°åœ†ç‚¹ä¸Šï¼Œå¯ä»¥çœ‹åˆ°è¯¥å…³é”®è¯çš„é¢‘æ¬¡ã€‚<br>
    </div>

    <div style="margin-top:4px; margin-bottom:8px;">
        <span class="range-pill active" id="range-all" onclick="setRange('all')">å…¨éƒ¨å†å²</span>
        <span class="range-pill" id="range-30" onclick="setRange('30')">æœ€è¿‘ 30 å¤©</span>
        <span class="range-pill" id="range-7" onclick="setRange('7')">æœ€è¿‘ 7 å¤©</span>
    </div>

    <div id="map-container">
      <div id="map"></div>
    </div>

    <div id="map-nodata" class="nodata" style="display:none;">
        ç›®å‰è¿˜æ²¡æœ‰å¯ç”¨æ•°æ® ğŸ¸ <br>
        è¯·å…ˆåœ¨è®­ç»ƒä¸»é¡µå¤šå†™å‡ æ¡è®°å½•ï¼Œç„¶åå†å›æ¥çœ‹çœ‹ä½ çš„æ€ç»´å®‡å®™ã€‚
    </div>
  </div>

</div>

<div id="tooltip" class="tooltip" style="display:none;"></div>

<script>
// =========== å…¨å±€å˜é‡ ==========
let currentRange = "all"; // all / 30 / 7

function setRange(r) {
    currentRange = r;
    document.getElementById("range-all").classList.toggle("active", r==="all");
    document.getElementById("range-30").classList.toggle("active", r==="30");
    document.getElementById("range-7").classList.toggle("active", r==="7");
    drawMindMap(); // é‡æ–°ç»˜åˆ¶
}

// =========== ç»˜åˆ¶æ˜Ÿå›¾ä¸»å‡½æ•° ==========
function drawMindMap() {
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");
    if (!logs.length) {
        document.getElementById("map").innerHTML = "";
        document.getElementById("map-nodata").style.display = "block";
        return;
    }

    const now = Date.now();
    let filtered = logs;
    if (currentRange === "30") {
        const ms = 30 * 24 * 3600 * 1000;
        filtered = logs.filter(r => now - new Date(r.date).getTime() < ms);
    } else if (currentRange === "7") {
        const ms = 7 * 24 * 3600 * 1000;
        filtered = logs.filter(r => now - new Date(r.date).getTime() < ms);
    }

    if (!filtered.length) {
        document.getElementById("map").innerHTML = "";
        document.getElementById("map-nodata").style.display = "block";
        return;
    } else {
        document.getElementById("map-nodata").style.display = "none";
    }

    // ===== 1. æå–æ–‡æœ¬ & å…ƒç´ /æ ‡å‡†
    let textAll = "";
    filtered.forEach(r=>{
        textAll += " " + (r.text || "") + " " + (r.element || "") + " " + (r.standard || "");
    });

    // ===== 2. ç®€å•ä¸­æ–‡&è‹±æ–‡åˆ†è¯
    textAll = textAll.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]+/g, " ");
    const rawTokens = textAll.split(/\s+/).filter(Boolean);

    // åœç”¨è¯ï¼ˆç®€å•ç‰ˆï¼‰
    const stopWords = [
        "æˆ‘ä»¬","ä½ ä»¬","ä»–ä»¬","è‡ªå·±","è¿™ä¸ª","é‚£ä¸ª","å°±æ˜¯","ç„¶å",
        "å¦‚æœ","å› ä¸º","æ‰€ä»¥","æ„Ÿè§‰","å¯èƒ½","è¿˜æ˜¯","æœ‰ç‚¹","éå¸¸",
        "ä¸€ç§","ä¸€äº›","å¾ˆå¤š","æ¯”è¾ƒ","å¯ä»¥","ä¸ä¼š","ä¸æ˜¯","æ²¡æœ‰","è§‰å¾—"
    ];

    const tokens = rawTokens.filter(w=>{
        // ä¸­æ–‡ï¼šé•¿åº¦è‡³å°‘2ï¼›è‹±æ–‡ï¼šè‡³å°‘3
        const isChinese = /[\u4e00-\u9fa5]/.test(w);
        if (isChinese && w.length < 2) return false;
        if (!isChinese && w.length < 3) return false;
        if (stopWords.includes(w)) return false;
        return true;
    });

    if (!tokens.length) {
        document.getElementById("map").innerHTML = "";
        document.getElementById("map-nodata").style.display = "block";
        return;
    }

    // ===== 3. ç»Ÿè®¡é¢‘ç‡
    const freqMap = {};
    tokens.forEach(w=> freqMap[w] = (freqMap[w] || 0) + 1);

    let entries = Object.entries(freqMap);
    // æŒ‰é¢‘ç‡æ’åºï¼Œå–å‰ 25 ä¸ª
    entries.sort((a,b)=>b[1]-a[1]);
    entries = entries.slice(0, 25);

    const nodes = entries.map(([word, count], i)=>({
        id: word,
        count,
        r: 10 + count * 4,
        group: i % 5
    }));

    // ===== 4. å…±ç°å…³ç³»ï¼ˆç²—ç•¥ï¼šéšæœºè¿ 1~3 æ¡è¾¹ï¼‰
    const links = [];
    for (let i=0; i<nodes.length; i++) {
        for (let j=i+1; j<nodes.length; j++) {
            if (Math.random() < 0.09) { // å°‘é‡è¿çº¿
                links.push({source:nodes[i].id, target:nodes[j].id});
            }
        }
    }

    const width = 900;
    const height = 480;

    // æ¸…ç©ºæ—§å›¾
    d3.select("#map").html("");

    const svg = d3.select("#map")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio", "xMidYMid meet");

    const color = d3.scaleOrdinal()
        .domain([0,1,2,3,4])
        .range(["#22c55e","#16a34a","#15803d","#0f766e","#4ade80"]);

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d=>d.id).distance(80).strength(0.5))
        .force("charge", d3.forceManyBody().strength(-120))
        .force("center", d3.forceCenter(width/2, height/2))
        .force("collision", d3.forceCollide().radius(d=>d.r+4));

    const link = svg.append("g")
        .attr("stroke", "#a7f3d0")
        .attr("stroke-opacity", 0.7)
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke-width", 1.2);

    const node = svg.append("g")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class","node")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        );

    node.append("circle")
        .attr("r", d=>d.r)
        .attr("fill", d=>color(d.group))
        .on("mousemove", (event,d)=>showTooltip(event, d))
        .on("mouseleave", hideTooltip);

    node.append("text")
        .text(d=>d.id)
        .attr("text-anchor","middle")
        .attr("dy", 4);

    simulation.on("tick", ()=>{
        link
            .attr("x1", d=>d.source.x)
            .attr("y1", d=>d.source.y)
            .attr("x2", d=>d.target.x)
            .attr("y2", d=>d.target.y);

        node
            .attr("transform", d=>`translate(${d.x},${d.y})`);
    });

    function dragstarted(event,d){
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    function dragged(event,d){
        d.fx = event.x;
        d.fy = event.y;
    }
    function dragended(event,d){
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

// tooltip
const tooltip = document.getElementById("tooltip");
function showTooltip(event,d){
    tooltip.style.display = "block";
    tooltip.style.left = (event.pageX + 8) + "px";
    tooltip.style.top = (event.pageY + 8) + "px";
    tooltip.innerText = `${d.id} Â· å‡ºç° ${d.count} æ¬¡`;
}
function hideTooltip(){
    tooltip.style.display = "none";
}

// åˆå§‹ç»˜åˆ¶
drawMindMap();
</script>

</body>
</html>
